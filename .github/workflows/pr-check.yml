name: PR Quality Gates

on:
  pull_request:
    branches:
      - main
    paths:
      - "apps/web/**"
      - ".github/workflows/pr-check.yml"

concurrency:
  group: pr-check-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Run ESLint
        working-directory: apps/web
        run: npm run lint

  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Build application
        working-directory: apps/web
        run: npm run build

      - name: Generate build summary
        run: |
          echo "## Build Summary âœ…" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **PR**: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Branch**: \`${{ github.head_ref }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit**: ${{ github.event.pull_request.head.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Author**: @${{ github.event.pull_request.user.login }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Build Output" >> "$GITHUB_STEP_SUMMARY"
          echo "Build artifacts generated in \`apps/web/dist/\`" >> "$GITHUB_STEP_SUMMARY"
          
          if [ -d "apps/web/dist" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Files:**" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            ls -lh apps/web/dist/ >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

  summary:
    name: Quality Check Summary
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: always()
    steps:
      - name: Generate PR summary
        run: |
          echo "## PR Quality Gates Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
            echo "ðŸŽ‰ **All quality checks passed!** This PR is ready to merge." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ **Some quality checks failed.** Please fix the issues before merging." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Check all jobs passed
        if: needs.lint.result != 'success' || needs.build.result != 'success'
        run: exit 1
