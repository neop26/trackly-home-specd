name: Deploy Supabase (DEV)

on:
  push:
    branches:
      - dev
    paths:
      - "supabase/migrations/**"
      - "supabase/functions/**"
      - "supabase/config.toml"
      - ".github/workflows/supabase-deploy-dev.yml"

  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: supabase-dev
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    env:
      DASHBOARD_BASE: https://supabase.com/dashboard/project

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Push database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          yes | supabase db push | tee db_push.log

      - name: Set Edge Function secrets
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SB_URL: ${{ secrets.SB_URL }}
          SB_ANON_KEY: ${{ secrets.SB_ANON_KEY }}
          SB_SERVICE_ROLE_KEY: ${{ secrets.SB_SERVICE_ROLE_KEY }}
          SITE_URL: ${{ secrets.SITE_URL }}
          INVITE_TOKEN_SECRET: ${{ secrets.INVITE_TOKEN_SECRET }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM: ${{ secrets.RESEND_FROM }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
        run: |
          # Prefer CORS_ORIGINS; fallback to ALLOWED_ORIGINS
          if [[ -z "${CORS_ORIGINS:-}" ]]; then
            export CORS_ORIGINS="${ALLOWED_ORIGINS:-}"
          fi

          cat > .env.functions <<EOF
          SB_URL=$SB_URL
          SB_ANON_KEY=$SB_ANON_KEY
          SB_SERVICE_ROLE_KEY=$SB_SERVICE_ROLE_KEY
          SITE_URL=$SITE_URL
          INVITE_TOKEN_SECRET=$INVITE_TOKEN_SECRET
          RESEND_API_KEY=$RESEND_API_KEY
          RESEND_FROM=$RESEND_FROM
          CORS_ORIGINS=$CORS_ORIGINS
          EOF

          supabase secrets set --project-ref "$SUPABASE_PROJECT_REF" --env-file .env.functions | tee secrets_set.log
          rm -f .env.functions

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase functions deploy --project-ref "$SUPABASE_PROJECT_REF" | tee functions_deploy.log

      - name: Generate deployment summary
        if: always()
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo "## Supabase DEV Deploy Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Workflow**: \`${{ github.workflow }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit**: ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Links" >> "$GITHUB_STEP_SUMMARY"
          echo "- [Supabase Project](${DASHBOARD_BASE}/${SUPABASE_PROJECT_REF})" >> "$GITHUB_STEP_SUMMARY"
          echo "- [Edge Functions](${DASHBOARD_BASE}/${SUPABASE_PROJECT_REF}/functions)" >> "$GITHUB_STEP_SUMMARY"
          echo "- [Auth Settings](${DASHBOARD_BASE}/${SUPABASE_PROJECT_REF}/auth/providers)" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Site URL**: \`${SITE_URL}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Database Migrations Applied" >> "$GITHUB_STEP_SUMMARY"
          echo "| Migration |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|" >> "$GITHUB_STEP_SUMMARY"
          if ls supabase/migrations/*.sql >/dev/null 2>&1; then
            for f in supabase/migrations/*.sql; do
              echo "| \`$(basename "$f")\` |" >> "$GITHUB_STEP_SUMMARY"
            done
          else
            echo "| (none) |" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Edge Functions Deployed" >> "$GITHUB_STEP_SUMMARY"
          echo "| Function |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|" >> "$GITHUB_STEP_SUMMARY"
          if ls supabase/functions/*/index.ts >/dev/null 2>&1; then
            for d in supabase/functions/*; do
              if [[ -f "$d/index.ts" ]]; then
                echo "| \`$(basename "$d")\` |" >> "$GITHUB_STEP_SUMMARY"
              fi
            done
          else
            echo "| (none) |" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Deployment Logs" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "<details><summary>Database Migration Log</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          if [[ -f db_push.log ]]; then tail -n 30 db_push.log >> "$GITHUB_STEP_SUMMARY"; else echo "(no log)" >> "$GITHUB_STEP_SUMMARY"; fi
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "<details><summary>Secrets Configuration Log</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          if [[ -f secrets_set.log ]]; then tail -n 30 secrets_set.log >> "$GITHUB_STEP_SUMMARY"; else echo "(no log)" >> "$GITHUB_STEP_SUMMARY"; fi
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "<details><summary>Edge Functions Deployment Log</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          if [[ -f functions_deploy.log ]]; then tail -n 50 functions_deploy.log >> "$GITHUB_STEP_SUMMARY"; else echo "(no log)" >> "$GITHUB_STEP_SUMMARY"; fi
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"
